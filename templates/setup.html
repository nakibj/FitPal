<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Choose Your Avatar | Virtual Closet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .status-message {
        margin-top: 1rem;
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-weight: 500;
    }
    .status-message.success {
        background-color: #d1fae5;
        color: #065f46;
    }
    .status-message.error {
        background-color: #fee2e2;
        color: #991b1b;
    }
    .status-message.info {
        background-color: #e0f2fe;
        color: #0c4a6e;
    }
    .avatar-option {
      width: 200px;
      height: 250px;
      background: #f3f4f6;
      border: 3px solid #e5e7eb;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .avatar-option:hover {
      border-color: #3b82f6;
      transform: translateY(-4px);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
    }
    .avatar-option.selected {
      border-color: #1d4ed8;
      background: #eff6ff;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(29, 78, 216, 0.25);
    }
    .avatar-option.selected::after {
      content: '‚úì';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #1d4ed8;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    .avatar-placeholder {
      width: 120px;
      height: 160px;
      background: #d1d5db;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
      font-size: 48px;
      color: #6b7280;
    }
    .avatar-label {
      font-weight: 600;
      color: #374151;
      text-align: center;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  <nav class="gradient-bg text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <h1 class="text-xl font-bold">üëó Virtual Closet</h1>
      <a href="/" class="hover:text-gray-200 transition">‚Üê Back to Home</a>
    </div>
  </nav>

  <main class="container mx-auto max-w-6xl px-4 py-10">
    <div class="bg-white rounded-2xl shadow-xl p-8">
      <div class="text-center mb-10">
        <h2 class="text-4xl font-bold mb-4">Choose Your Avatar</h2>
        <p class="text-xl text-gray-600">Select the avatar that looks most similar to you</p>
      </div>

      <form id="avatarForm">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-10">
          <!-- Fat Man -->
          <div class="avatar-option" data-avatar="fat_man">
            <div class="avatar-placeholder">
              üë®
            </div>
          </div>

          <!-- Fat Woman -->
          <div class="avatar-option" data-avatar="fat_woman">
            <div class="avatar-placeholder">
              üë©
            </div>
          </div>

          <!-- Skinny Man -->
          <div class="avatar-option" data-avatar="skinny_man">
            <div class="avatar-placeholder">
              üßë
            </div>
          </div>

          <!-- Skinny Woman -->
          <div class="avatar-option" data-avatar="skinny_woman">
            <div class="avatar-placeholder">
              üë±‚Äç‚ôÄÔ∏è
            </div>
          </div>

          <!-- Fit Man -->
          <div class="avatar-option" data-avatar="fit_man">
            <div class="avatar-placeholder">
              üí™
            </div>
          </div>

          <!-- Fit Woman -->
          <div class="avatar-option" data-avatar="fit_woman">
            <div class="avatar-placeholder">
              üèÉ‚Äç‚ôÄÔ∏è
            </div>
          </div>
        </div>

        <!-- Style Preferences Section -->
        <div class="bg-gray-50 rounded-xl p-6 mb-8">
          <h3 class="text-xl font-semibold mb-4 text-gray-700">Preferred Styles</h3>
          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <input type="checkbox" id="style_streetwear" name="preferred_styles" value="streetwear" class="hidden peer" />
              <label for="style_streetwear" class="block p-4 border-2 border-gray-300 rounded-lg cursor-pointer text-center hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition">Streetwear</label>
            </div>
            <div>
              <input type="checkbox" id="style_old_money" name="preferred_styles" value="old_money" class="hidden peer" />
              <label for="style_old_money" class="block p-4 border-2 border-gray-300 rounded-lg cursor-pointer text-center hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition">Old Money</label>
            </div>
            <div>
              <input type="checkbox" id="style_alt" name="preferred_styles" value="alt" class="hidden peer" />
              <label for="style_alt" class="block p-4 border-2 border-gray-300 rounded-lg cursor-pointer text-center hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition">Alt</label>
            </div>
            <div>
                <input type="checkbox" id="style_casual" name="preferred_styles" value="casual" class="hidden peer" />
                <label for="style_casual" class="block p-4 border-2 border-gray-300 rounded-lg cursor-pointer text-center hover:border-blue-500 peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition">Casual</label>
            </div>
          </div>
        </div>

        <input type="hidden" id="selected_avatar" name="selected_avatar" />
        <input type="hidden" id="latitude" name="latitude" />
        <input type="hidden" id="longitude" name="longitude" />

        <div id="location-status" class="status-message hidden"></div>

        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 px-6 rounded-xl transition text-lg">
          Save Profile
        </button>
      </form>
    </div>
  </main>

  <script>
    const locationStatusDiv = document.getElementById('location-status');
    let selectedAvatar = null;

    function showStatus(message, type) {
        locationStatusDiv.textContent = message;
        locationStatusDiv.classList.remove('hidden', 'success', 'error', 'info');
        locationStatusDiv.classList.add(type);
    }

    // Handle avatar selection
    document.querySelectorAll('.avatar-option').forEach(option => {
      option.addEventListener('click', () => {
        // Remove selection from all options
        document.querySelectorAll('.avatar-option').forEach(opt => {
          opt.classList.remove('selected');
        });
        
        // Add selection to clicked option
        option.classList.add('selected');
        selectedAvatar = option.dataset.avatar;
        document.getElementById('selected_avatar').value = selectedAvatar;
        
        console.log('Selected avatar:', selectedAvatar);
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
        // Attempt to get location when the page loads
        if ("geolocation" in navigator) {
            showStatus('üåç Requesting your location for weather-based outfit recommendations...', 'info');
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    document.getElementById('latitude').value = lat;
                    document.getElementById('longitude').value = lon;
                    showStatus(`‚úÖ Location captured successfully! (${lat.toFixed(4)}, ${lon.toFixed(4)})`, 'success');
                    console.log('üìç Location captured:', lat, lon);
                    console.log('üìç Location accuracy:', position.coords.accuracy, 'meters');
                },
                (error) => {
                    let errorMessage = '‚ö†Ô∏è Could not get location.';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = '‚ùå Location permission denied. You can still use the app, but weather-based recommendations will be limited.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = '‚ùå Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = '‚è∞ Location request timed out. Please try again.';
                            break;
                        default:
                            errorMessage = '‚ùå An unknown error occurred while getting location.';
                            break;
                    }
                    showStatus(errorMessage, 'error');
                    console.error("Geolocation error:", error);
                    // Explicitly set empty values when location fails
                    document.getElementById('latitude').value = '';
                    document.getElementById('longitude').value = '';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,  // Increased timeout to 15 seconds
                    maximumAge: 300000  // Allow cached position up to 5 minutes old
                }
            );
        } else {
            showStatus('‚ùå Geolocation is not supported by your browser.', 'error');
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
        }
    });

    document.getElementById('avatarForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedAvatar) {
        alert('Please select an avatar that looks most similar to you');
        return;
      }

      const styles = Array.from(document.querySelectorAll('input[name="preferred_styles"]:checked'))
        .map(cb => cb.value);

      if (styles.length === 0) {
        alert('Please select at least one style preference');
        return;
      }

      const latitude = document.getElementById('latitude').value;
      const longitude = document.getElementById('longitude').value;

      const data = {
        selected_avatar: selectedAvatar,
        preferred_styles: styles,
        latitude: latitude || null,
        longitude: longitude || null
      };

      console.log('üì§ Sending profile data:', data);
      console.log('üìç Location data being sent:', {
        latitude: data.latitude,
        longitude: data.longitude,
        hasLocation: !!(data.latitude && data.longitude),
        latitudeType: typeof data.latitude,
        longitudeType: typeof data.longitude
      });

      // Show loading state
      const submitButton = e.target.querySelector('button[type="submit"]');
      const originalText = submitButton.textContent;
      submitButton.textContent = 'Saving Profile...';
      submitButton.disabled = true;

      try {
        const response = await fetch('/setup', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        const result = await response.json();
        console.log('üì• Server response:', result);

        if (result.success) {
          showStatus('‚úÖ Profile saved successfully! Redirecting to your profile...', 'success');
          setTimeout(() => {
            window.location.href = '/profile';
          }, 1500);
        } else {
          showStatus('‚ùå Error: ' + (result.message || 'Something went wrong'), 'error');
          submitButton.textContent = originalText;
          submitButton.disabled = false;
        }
      } catch (error) {
        console.error('‚ùå Network error:', error);
        showStatus('‚ùå Network error occurred. Please check your connection and try again.', 'error');
        submitButton.textContent = originalText;
        submitButton.disabled = false;
      }
    });
  </script>
</body>
</html>